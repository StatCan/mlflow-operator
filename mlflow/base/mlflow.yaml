apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: mlflow
spec:
  gateways:
  - istio-system/istio-autogenerated-k8s-ingress
  hosts:
  - mlflow.covid.cloud.statcan.ca
  http:
  - match:
    - uri:
        exact: /api/get-artifact
    rewrite:
      uri: /get-artifact
    route:
    - destination:
        host: mlflow
        port:
          number: 5000
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: mlflow
        port:
          number: 5000
---
apiVersion: security.cloud.ibm.com/v1
kind: OidcConfig
metadata:
  name: mlflow
spec:
  clientId: clientid
  clientSecretRef:
    key: client-secret
    name: mlflow
  discoveryUrl: discoveryurl
  scopes: null
---
apiVersion: security.cloud.ibm.com/v1
kind: JwtConfig
metadata:
    name: mlflow
spec:
    jwksUrl: jwksUrl
---
apiVersion: security.cloud.ibm.com/v1
kind: Policy
metadata:
  name: mlflow
spec:
  targets:
  - paths:
    - prefix: /api
      method: ALL
      policies:
      - policyType: jwt
        config: mlflow
    - prefix: /
      method: ALL
      policies:
      - config: mlflow
        policyType: oidc
        redirectUri: https://mlflow.example.ca
        rules:
        - claim: groups
          match: ANY
          source: id_token
          values:
          - group_admin
          - group_alt
    serviceName: mlflow
